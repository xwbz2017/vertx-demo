<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>绘本demo2</title>
    <script src="https://code.createjs.com/1.0.0/soundjs.min.js"></script>
    <script src="https://code.createjs.com/1.0.0/preloadjs.min.js"></script>
    <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
    <style>
        #postman{
            width: 60%;
            margin: 20%;
            word-break: break-all;
            line-height: 30px;
        }
        #postman span{
            margin: 5px;
            cursor: pointer;
            background-color: antiquewhite;
        }
        #postman span:active, #postman span:focus{
            color:red;
        }
    </style>
    <script>
        var instance, postman, idx = 0, spanArr,
            txt = 'If there were none of this playing at generosity in warfare,we should never go to war,except for something worth facing certain death for,as now.',
             queue, isClick=false, soundId = 'sound';

        var audio = {
            audio:null,
            split:[]
        };

        function getAudio() {
            $.get('/body2/' + txt).success(function (res) {
                audio = res;

                initSound([{id:soundId, soundUrl:audio.audio}]);

                var html = txt;
                var finalHtml = '';
                for (var i in audio.split) {
                    var t = audio.split[i][0];
                    var z = html.indexOf(t);
                    var hasTrans = audio.split[i].length > 3;

                    finalHtml += html.substring(0, z)
                        + ('<span data-begin="'+audio.split[i][1]+'" data-duration="'+audio.split[i][2] +'" '+
                            (hasTrans ? 'data-trans="' + audio.split[i][3] + '"' : '')+'>' + t + '</span>');
                    html = html.substring(z + t.length);
                }
                postman.innerHTML = finalHtml;

                spanArr = postman.getElementsByTagName('span');

                $("#postman span").on("click", function () {
                    isClick = true;

                    var trans = $(this).data("trans");
                    if(trans){
                        $(this).append($('<sup>', {text:trans}));
                    }
                    doPlay(soundId, {startTime:$(this).data("begin"), duration:$(this).data("duration")});
                });
            }).error(function () {
                console.error('错误');
            })
        }


        $(function () {
            queue = new createjs.LoadQueue();
            queue.installPlugin(createjs.Sound);
            queue.on("complete", loadHandler);
            queue.on("fileload", loadOne);
            postman = document.getElementById('postman');
            getAudio();
        });

        function initSound(sounds) {
            for (var i in sounds) {
                queue.loadFile({id: sounds[i].id, src: '/audio/' + sounds[i].soundUrl});
            }
        }

        function loadOne(e) {
            console.log(e);
        }

        function loadHandler() {
            console.log('loadHandler', '加载完成');

            doPlay(soundId);
        }

        function doPlay(s, options) {
            console.log(options);
            if(instance){
                instance.stop();
                clearCss(idx);
            }
            // {startTime:1000, duration:1000}
            instance = createjs.Sound.play(s, options);
            instance.on("complete", handleComplete);
        }

        function handleComplete(e) {
            console.log(e.target.src + ' -> 完毕');

            setTimeout(function () {
                $("#postman span>sup").remove();
            }, 1200);
        }

        function clearCss(i) {
            if (i > 0) {
                spanArr[i - 1].style = '';
            }
            if (i < spanArr.length)
                spanArr[i].style = '';
        }
    </script>
</head>
<body>
<div id="postman"></div>
<a href="demo">学拼读demo</a>
<a href="index">绘本demo1</a>
<p>
<p>已完成：</p>
<p>1.朗读文本</p>
<p>2.点击播放指定单词以及翻译</p>
<p>3.根据文本长度相对位置朗读</p>
<p>4.与demo1的区别是音频只有一个，节省资源</p>
<p> 不足：</p>
<p> 1.单词位置不准确</p>
<p> 2.重点单词需要另外录入，目前是整个语句都能读和翻译，应该是只有部分重点单词可以</p>
</p>
</body>
</html>