<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>绘本demo1</title>
    <script src="https://code.createjs.com/1.0.0/soundjs.min.js"></script>
    <script src="https://code.createjs.com/1.0.0/preloadjs.min.js"></script>
    <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
    <style>
        #postman{
            width: 60%;
            margin: 20%;
            word-break: break-all;
            line-height: 30px;
        }
        #postman span{
            margin: 5px;
            cursor: pointer;
            background-color: antiquewhite;
        }
        #postman span:active, #postman span:focus{
            color:red;
        }
    </style>
    <script>
        var instance, postman, idx = 0, spanArr,
            txt = 'If there were none of this playing at generosity in warfare,we should never go to war,except for something worth facing certain death for,as now.',
            soundUrl, queue, loadedNum = 0, isClick=false;

        // var txtArr = txt.split(/[,.，。‘’“”'"\r\n]/);
        var txtArr = txt.split(/\W/);
        var tempArr = [];
        for (var i in txtArr) {
            if (txtArr[i]) {
                tempArr.push({txt: txtArr[i], id: 'sound' + i})
            }
        }
        txtArr = tempArr;

        // var ppc = new createjs.PlayPropsConfig().set({interrupt: createjs.Sound.INTERRUPT_ANY, loop: -1, volume: 1})

        function getAudio(index, txt) {
            $.get('/body/' + txt).success(function (res) {
                soundUrl = '/audio/' + res;
                txtArr[index].soundUrl = soundUrl;
                loadedNum++;
                if (loadedNum === txtArr.length) {
                    initSound(txtArr);
                }
            }).error(function () {
                console.error('错误');
            })
        }


        $(function () {
            queue = new createjs.LoadQueue();
            queue.installPlugin(createjs.Sound);
            queue.on("complete", loadHandler);
            queue.on("fileload", loadOne);
            postman = document.getElementById('postman');

            var html = txt;
            var finalHtml = '';
            for (var i in txtArr) {
                var t = txtArr[i].txt;
                var z = html.indexOf(t);

                finalHtml += html.substring(0, z) + ('<span data-audio="'+txtArr[i].id+'">' + t + '</span>');
                html = html.substring(z + t.length);
                getAudio(i, txtArr[i].txt);
            }
            postman.innerHTML = finalHtml;

            spanArr = postman.getElementsByTagName('span');

            $("#postman span").on("click", function () {
                isClick = true;
                doPlay($(this).data("audio"));
            });
        });

        function initSound(sounds) {
            for (var i in sounds) {
                queue.loadFile({id: sounds[i].id, src: sounds[i].soundUrl});
            }
        }

        function loadOne(e) {
            console.log(e);
        }

        function loadHandler(event) {
            console.log('loadHandler', '加载完成')
            // 这会引发针对每个已注册的声音。
            play(idx);
        }

        function play(i) {
            if (i === txtArr.length) {
                position(i);
                return;
            }
            doPlay(txtArr[i].id);
            position(i);
        }

        function doPlay(s) {
            if(instance){
                instance.stop();
                clearCss(idx);
            }
            instance = createjs.Sound.play(s);
            // instance = createjs.Sound.play(s, {startTime:1000, duration:1000});
            instance.on("complete", handleComplete);
        }

        function handleComplete(e) {
            console.log(e.target.src + ' -> 完毕');
            if(!isClick) {
                play(++idx);
            }
        }

        function clearCss(i) {
            if (i > 0) {
                spanArr[i - 1].style = '';
            }
            if (i < txtArr.length)
                spanArr[i].style = '';
        }

        function position(i) {
            clearCss(i);
            if (i < txtArr.length)
                spanArr[i].style = 'color:red;';
        }
    </script>
</head>
<body>
<div id="postman"></div>
<a href="demo">学拼读demo</a>
<a href="index2">绘本demo2</a>
<p>
<p>已完成：</p>
<p>1.朗读文本</p>
<p>2.点击播放指定单词</p>
<p>3.与demo2的区别是音频有多个，读单个单词准确</p>
<p> 不足：</p>
<p>1.读音不连贯</p>
<p>2.资源耗费比较多</p>
<p> 3.重点单词需要另外录入，目前是整个语句都能读和翻译，应该是只有部分重点单词可以</p>
</p>
</body>
</html>